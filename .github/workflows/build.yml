name: Build QMK Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: qmk/qmk_firmware
        path: qmk_firmware
        submodules: recursive

    - name: Copy keymap to QMK
      run: |
        mkdir -p qmk_firmware/keyboards/lily58/keymaps/ergomech_custom
        cp -r keymaps/ergomech_custom/* qmk_firmware/keyboards/lily58/keymaps/ergomech_custom/

    - name: Build firmware for LEFT side (slave)
      run: |
        cd qmk_firmware
        qmk compile -kb lily58/rev1 -km ergomech_custom -e CONVERT_TO=rp2040_ce -bl uf2-split-left
        mv *.uf2 lily58_LEFT.uf2

    - name: Build firmware for RIGHT side (master)
      run: |
        cd qmk_firmware
        qmk compile -kb lily58/rev1 -km ergomech_custom -e CONVERT_TO=rp2040_ce -bl uf2-split-right
        mv *.uf2 lily58_RIGHT.uf2

    - name: Upload LEFT firmware
      uses: actions/upload-artifact@v4
      with:
        name: lily58-LEFT-flash-to-left-module
        path: qmk_firmware/lily58_LEFT.uf2
        if-no-files-found: error

    - name: Upload RIGHT firmware
      uses: actions/upload-artifact@v4
      with:
        name: lily58-RIGHT-flash-to-right-module
        path: qmk_firmware/lily58_RIGHT.uf2
        if-no-files-found: error
